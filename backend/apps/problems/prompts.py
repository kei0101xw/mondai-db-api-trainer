def build_problem_generation_prompt(difficulty: str, app_scale: str, mode: str) -> str:
    """
    問題生成用のプロンプトを構築する

    Args:
        difficulty: 難易度 (easy/medium/hard)
        app_scale: アプリ規模 (small/medium/large)
        mode: モード (db_only/api_only/both)

    Returns:
        Gemini API に投げるプロンプト文字列
    """

    # 難易度の説明
    difficulty_desc = {
        "easy": "初心者向け。基本的なテーブル設計やCRUD APIのみ。",
        "medium": "中級者向け。リレーション、インデックス、複雑なクエリを含む。",
        "hard": "上級者向け。パフォーマンス最適化、セキュリティ、スケーラビリティを考慮。",
    }

    # アプリ規模の説明
    scale_desc = {
        "small": "小規模（5テーブル以下、5エンドポイント以下）",
        "medium": "中規模（5〜10テーブル、10〜15エンドポイント）",
        "large": "大規模（10テーブル以上、15エンドポイント以上）",
    }

    # モードに応じた問題タイプ
    mode_instruction = {
        "db_only": """
# 問題タイプ
- DB設計問題のみを生成してください

# 期待する出力
"problems" 配列には1つの要素（problem_type: "db"）のみを含めてください。
""",
        "api_only": """
# 問題タイプ
- API設計問題のみを生成してください

# 期待する出力
"problems" 配列には1つの要素（problem_type: "api"）のみを含めてください。
""",
        "both": """
# 問題タイプ
- DB設計問題とAPI設計問題の両方を生成してください

# 期待する出力
"problems" 配列には2つの要素を含めてください：
1. DB設計問題（problem_type: "db", order_index: 1）
2. API設計問題（problem_type: "api", order_index: 2）
""",
    }

    prompt = f"""あなたはバックエンドエンジニア向けの問題作成専門家です。
以下の条件に基づいて、データベース設計・API設計の練習問題を生成してください。

# 条件
- 難易度: {difficulty} ({difficulty_desc.get(difficulty, "")})
- アプリ規模: {app_scale} ({scale_desc.get(app_scale, "")})
- モード: {mode}

{mode_instruction.get(mode, "")}

# アプリの題材例
- SNSアプリ（投稿、いいね、フォロー機能）
- ECサイト（商品、カート、注文機能）
- タスク管理アプリ（プロジェクト、タスク、担当者管理）
- ブログシステム（記事、カテゴリ、コメント機能）
- 予約システム（施設、予約枠、予約管理）

上記はあくまで例です。他の現実的なWebアプリの題材でも構いません。

# 出力形式（JSON）
必ず以下のJSON形式で出力してください。JSONのみを出力し、それ以外の説明文は含めないでください。

```json
{{
  "title": "題材のタイトル（例：SNSアプリ）",
  "description": "アプリの概要説明。どのような機能を持つアプリか詳しく記述。",
  "problems": [
    {{
      "problem_type": "db",
      "order_index": 1,
      "problem_body": "DB設計問題の本文。具体的な要件を記述。\\n\\n以下の要件を満たすデータベース設計を行ってください。\\n\\n■要件に含めるべき観点（問題文側で指定する）\\n- 主要エンティティと関係（リレーション）\\n- カラム（型、必須/任意、制約）\\n- 主キー/外部キー、ユニーク制約、NOT NULL、CHECK など\\n- 重要な検索条件がある場合はインデックス方針\\n- 削除方針（論理削除/物理削除）や履歴が必要ならその要件\\n\\n■回答フォーマット\\n- SQLのCREATE TABLE文で回答してください。"
    }},
    {{
      "problem_type": "api",
      "order_index": 2,
      "problem_body": "API設計問題の本文。具体的な要件を記述。\\n\\n以下の要件を満たすAPIを設計し、擬似コードで実装方針を示してください。\\n\\n■要件に含めるべき観点（問題文側で指定する）\\n- 操作（作成/取得/更新/削除、状態変更など）\\n- 一覧取得の条件（フィルタ、ソート、ページング）\\n- 認証・認可（誰が何をできるか）\\n- 入出力の項目（必須/任意、型、制約）\\n- エラー条件（400/401/403/404/409などが起きる具体条件）\\n- 可能なら非機能要件（冪等性、レート制限、監査ログ等）は難易度に応じて追加\\n\\n※HTTPメソッドやURLパスは問題文に直接書かず、回答者が設計してください。\\n※『例：GET /xxx』のような具体例の提示も禁止です（プレースホルダ表記のみ可）。\\n\\n■回答フォーマット（回答者が埋める）\\n1. API設計情報\\n- [METHOD] [PATH] : 目的\\n  - 認証/認可：\\n  - Request：\\n  - Response：\\n  - エラー：\\n（必要なエンドポイント分だけ繰り返す）\\n\\n2. 疑似コード（言語非依存で可）\\n- handler/controller相当の疑似コード\\n- DBアクセスや外部サービス呼び出しは抽象化して構いません"
    }}
  ]
}}
```

# 注意事項
- problem_body には具体的な要件を詳しく記述してください
- DB設計問題では、テーブル構造、カラム、制約、リレーションを明確に示してください
- problem_body は「要件・制約・ユースケース」のみを書いてください。解答（設計案）に当たる具体例は書かないでください。
- API設計問題では、HTTPメソッド（GET/POST等）や具体的なURLパス（/users/:id等）を問題文に直接書かないでください。代わりに「必要な操作（例：投稿作成、一覧取得…）」「期待する入出力」「認可要件」「一覧の絞り込み/ページング条件」などを要件として列挙してください。
- API設計問題の回答では、以下の2点を必ず含める形式としてください。
  1. API設計情報（HTTPメソッド、エンドポイント、役割、認証、入出力）
  2. 上記設計に基づく疑似コード（言語非依存で可）
- 難易度とアプリ規模に応じて、問題の複雑さを調整してください
- 必ずJSONのみを出力してください（```json マーカーも不要です）
"""

    return prompt
